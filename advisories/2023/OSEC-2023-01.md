```
id: OSEC-2023-01
modified: "2026-01-09T12:00:00Z"
published: "2023-05-25T12:00:00Z"
affected: "opam-repository" {>= "2" & < "2.1.5"}
events: [
  git "git+https://github.com/ocaml/opam" [
    [introduced "cfa4e77b49d0bccaf5c91b2e6f36089aab5e0540"]
    [fixed "7a538fd0bf3b3956d84bb25d0f6b1126fa177595"]
  ]
]
references: [
  [fix "https://github.com/ocaml/opam/pull/5538"]
  [article "https://opam.ocaml.org/blog/opam-2-1-5-local-cache/"]
]
credits: [
  [reporter "Reynir BjÃ¶rnsson"]
  [reporter "Hannes Mehnert"]
  [remediation_developer "Kate"]
  [remediation_reviewer "Raja Boujbel"]
]
```

# Time of check time of use issue in opam's cache

## Bug description

Opam uses since version 2.0.0 a download cache: if a source artifact is needed, first its hash is looked up in the local cache (~/.opam/download-cache/<hash-algorihm>/<hash>). Opam supports multiple hash algorithms, a cache lookup tries all hash algorithms present in the opam file. Before opam 2.1.5, the hash of a cache entry that lead to the cache hit was not checked.

If a package specifies only a single (non-weak) hash algorithm, this lead to the source artifact taken as is, any error while writing the artifact into the cache, or reading it from the cache, was not detected. Also, in certain setups, if the download cache is shared (writable) across containers (for example in some CI systems), this leads to the possibility of cache poisoning.

Thanks to Raja and Kate, the issue was fixed in [PR 5538](https://github.com/ocaml/opam/pull/5538)

## Timeline

The timeline of this issue is as follows:

- Feb 23rd 2023 conducted black-box security audit of opam
- Feb 24th 2023 reported to the opam team
- Feb 27th 2023 video meeting with the opam team, explaining the issue further
- Mar 27th 2023 initial review meeting of the patches developed by the opam team
- May 9th 2023 public PR fixing the issue discovered
- May 25th 2023 release of opam 2.1.5
