```
id: OSEC-2019-02
modified: "2026-01-13T12:00:00Z"
published: "2019-04-26T00:00:00Z"
severity: "CVSS:3.0/AV:L/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N"
severity_score: "7.7 (High)"
affected: "mirage-xen" {< "3.3.0"}
events: [
  git "git+https://github.com/mirage/mirage-xen" [
    [fixed "f86e173922233568158c605ab98add623bedf948"]
  ]
]
references: [
  [fix "https://github.com/mirage/mirage-xen/pull/9"]
  [advisory "https://mirageos.org/blog/MSA02"]
]
credits: [
  [reporter "Mindy Preston"]
  [remediation_developer "Mindy Preston"]
  [remediation_developer "Thomas Leonard"]
]
cwe: [ CWE-252 ]
```

# Grant unshare vulnerability in mirage-xen

## Background

MirageOS is a library operating system using cooperative multitasking, which can be executed as a guest of the Xen hypervisor. Virtual machines running on a Xen host can communicate by sharing pages of memory. For example, when a Mirage VM wants to use a virtual network device provided by a Linux dom0:

1. The Mirage VM reserves some of its memory for this purpose and writes an entry to its grant table to say that dom0 should have access to it.
2. The Mirage VM tells dom0 (via XenStore) about the grant.
3. dom0 asks Xen to map the memory into its address space.

The Mirage VM and dom0 can now communicate using this shared memory. When dom0 has finished with the memory:

1. dom0 tells Xen to unmap the memory from its address space.
2. dom0 tells the Mirage VM that it no longer needs the memory.
3. The Mirage VM removes the entry from its grant table.
4. The Mirage VM may reuse the memory for other purposes.

## Problem Description

Mirage removes the entry by calling the gnttab_end_access function in Mini-OS. This function checks whether the remote domain still has the memory mapped. If so, it returns 0 to indicate that the entry cannot be removed yet. To make this function available to OCaml code, the stub_gntshr_end_access C stub in mirage-xen wrapped this with the OCaml calling conventions. Unfortunately, it ignored the return code and reported success in all cases.

## Impact

A malicious VM can tell a MirageOS unikernel that it has finished using some shared memory while it is still mapped. The Mirage unikernel will think that the unshare operation has succeeded and may reuse the memory, or allow it to be garbage collected. The malicious VM will still have access to the memory.

In many cases (such as in the example above) the remote domain will be dom0, which is already fully trusted. However, if a unikernel shares memory with an untrusted domain then there is a problem.

## Solution

Returning the result from the C stub required changes to the OCaml grant API to deal with the result. This turned out to be difficult because, for historical reasons, the OCaml part of the API was in the ocaml-gnt package while the C stubs were in mirage-xen, and because the C stubs are also shared with the Unix backend.

We instead created a new grant API in mirage-xen, migrated all existing Mirage drivers to use it, and then dropped support for the old API. mirage-xen 3.3.0 added support for the new API and 3.4.0 removed support for the old one.
